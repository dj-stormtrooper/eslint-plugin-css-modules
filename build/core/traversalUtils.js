'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.eliminateGlobals = exports.getParentSelectorClassesMap = exports.getExtendClassesMap = exports.getComposesClassesMap = exports.getRegularClassesMap = exports.getICSSExportPropsMap = undefined;

var _fp = require('lodash/fp');

var _fp2 = _interopRequireDefault(_fp);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var getICSSExportPropsMap = exports.getICSSExportPropsMap = function getICSSExportPropsMap(ast) {
  var ruleSets = [];
  ast.traverseByType('ruleset', function (node) {
    return ruleSets.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    var prop = _fp2.default.compose(_fp2.default.nth(0), _fp2.default.map('content'))(key);
    result[prop] = prop; // e.g. { myProp: 'myProp' }
    return result;
  }, {}), _fp2.default.map('content'), _fp2.default.filter({ type: 'property' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'declaration' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }), _fp2.default.flatMap('content'), _fp2.default.filter({
    content: [{
      type: 'selector',
      content: [{
        type: 'pseudoClass',
        content: [{
          type: 'ident', content: 'export'
        }]
      }]
    }]
  }))(ruleSets);
};
/* eslint-disable no-param-reassign */
var getRegularClassesMap = exports.getRegularClassesMap = function getRegularClassesMap(ast) {
  var ruleSets = [];
  ast.traverseByType('ruleset', function (node) {
    return ruleSets.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    result[key] = false; // classes haven't been used
    return result;
  }, {}), _fp2.default.map('content'), _fp2.default.filter({ type: 'ident' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'class' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'selector' }), _fp2.default.flatMap('content'))(ruleSets);
};

var getComposesClassesMap = exports.getComposesClassesMap = function getComposesClassesMap(ast) {
  var declarations = [];
  ast.traverseByType('declaration', function (node) {
    return declarations.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    result[key] = true; // mark composed classes as true
    return result;
  }, {}), _fp2.default.flatMap(_fp2.default.compose(_fp2.default.map(_fp2.default.get('content')), _fp2.default.filter({ type: 'ident' }), _fp2.default.get('content'), _fp2.default.find({ type: 'value' }), _fp2.default.get('content'))),
  /*
     reject classes composing from other files
     eg.
     .foo {
     composes: .bar from './otherFile';
     }
   */
  _fp2.default.reject(_fp2.default.compose(_fp2.default.find({ type: 'ident', content: 'from' }), _fp2.default.get('content'), _fp2.default.find({ type: 'value' }), _fp2.default.get('content'))), _fp2.default.filter(_fp2.default.compose(_fp2.default.find({ type: 'ident', content: 'composes' }), _fp2.default.get('content'), _fp2.default.find({ type: 'property' }), _fp2.default.get('content'))))(declarations);
};

var getExtendClassesMap = exports.getExtendClassesMap = function getExtendClassesMap(ast) {
  var extendNodes = [];
  ast.traverseByType('extend', function (node) {
    return extendNodes.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    result[key] = true; // mark extend classes as true
    return result;
  }, {}), _fp2.default.map(_fp2.default.compose(_fp2.default.get('content'), _fp2.default.find({ type: 'ident' }), _fp2.default.get('content'), _fp2.default.find({ type: 'class' }), _fp2.default.get('content'), _fp2.default.find({ type: 'selector' }), _fp2.default.get('content'))))(extendNodes);
};

/**
 * Resolves parent selectors to their full class names.
 *
 * E.g. `.foo { &_bar {color: blue } }` to `.foo_bar`.
 */
var getParentSelectorClassesMap = exports.getParentSelectorClassesMap = function getParentSelectorClassesMap(ast) {
  var classesMap = {};

  // Recursively traverses down the tree looking for parent selector
  // extensions. Recursion is necessary as these selectors can be nested.
  var getExtensions = function getExtensions(nodeContent) {
    var blockContent = _fp2.default.compose(_fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }))(nodeContent);

    var rulesetsContent = _fp2.default.flatMap('content', _fp2.default.concat(
    // `ruleset` children
    _fp2.default.filter({ type: 'ruleset' }, blockContent),

    // `ruleset` descendants nested in `include` nodes
    _fp2.default.compose(_fp2.default.filter({ type: 'ruleset' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'include' }))(blockContent)));

    var extensions = _fp2.default.compose(_fp2.default.map('content'), _fp2.default.filter({ type: 'ident' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'parentSelectorExtension' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'selector' }))(rulesetsContent);

    if (!extensions.length) return [];

    var nestedExtensions = getExtensions(rulesetsContent);
    var result = extensions;
    if (nestedExtensions.length) {
      nestedExtensions.forEach(function (nestedExt) {
        extensions.forEach(function (ext) {
          result.push(ext + nestedExt);
        });
      });
    }

    return result;
  };

  ast.traverseByType('ruleset', function (node) {
    var classNames = _fp2.default.compose(_fp2.default.map('content'), _fp2.default.filter({ type: 'ident' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'class' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'selector' }))(node.content);

    if (!classNames.length) return;

    var extensions = getExtensions(node.content);
    if (!extensions.length) return;

    classNames.forEach(function (className) {
      extensions.forEach(function (ext) {
        classesMap[className + ext] = false;
      });

      // Ignore the base class if it only exists for nesting parent selectors
      var hasDeclarations = _fp2.default.compose(_fp2.default.filter({ type: 'declaration' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }))(node.content).length > 0;
      if (!hasDeclarations) classesMap[className] = true;
    });
  });

  return classesMap;
};

/*
   mutates ast by removing instances of :global
 */
var eliminateGlobals = exports.eliminateGlobals = function eliminateGlobals(ast) {
  ast.traverse(function (node, index, parent) {
    if (node.type === 'ruleset') {
      if (_fp2.default.compose(_fp2.default.negate(_fp2.default.isEmpty), _fp2.default.find({ type: 'ident', content: 'global' }), _fp2.default.get('content'), _fp2.default.find({ type: 'pseudoClass' }), _fp2.default.get('content'), _fp2.default.find({ type: 'selector' }), _fp2.default.get('content'))(node)) {
        parent.removeChild(index);
      }
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb3JlL3RyYXZlcnNhbFV0aWxzLmpzIl0sIm5hbWVzIjpbImdldElDU1NFeHBvcnRQcm9wc01hcCIsImFzdCIsInJ1bGVTZXRzIiwidHJhdmVyc2VCeVR5cGUiLCJwdXNoIiwibm9kZSIsImZwIiwiY29tcG9zZSIsInJlZHVjZSIsInJlc3VsdCIsImtleSIsInByb3AiLCJudGgiLCJtYXAiLCJmaWx0ZXIiLCJ0eXBlIiwiZmxhdE1hcCIsImNvbnRlbnQiLCJnZXRSZWd1bGFyQ2xhc3Nlc01hcCIsImdldENvbXBvc2VzQ2xhc3Nlc01hcCIsImRlY2xhcmF0aW9ucyIsImdldCIsImZpbmQiLCJyZWplY3QiLCJnZXRFeHRlbmRDbGFzc2VzTWFwIiwiZXh0ZW5kTm9kZXMiLCJnZXRQYXJlbnRTZWxlY3RvckNsYXNzZXNNYXAiLCJjbGFzc2VzTWFwIiwiZ2V0RXh0ZW5zaW9ucyIsImJsb2NrQ29udGVudCIsIm5vZGVDb250ZW50IiwicnVsZXNldHNDb250ZW50IiwiY29uY2F0IiwiZXh0ZW5zaW9ucyIsImxlbmd0aCIsIm5lc3RlZEV4dGVuc2lvbnMiLCJmb3JFYWNoIiwiZXh0IiwibmVzdGVkRXh0IiwiY2xhc3NOYW1lcyIsImNsYXNzTmFtZSIsImhhc0RlY2xhcmF0aW9ucyIsImVsaW1pbmF0ZUdsb2JhbHMiLCJ0cmF2ZXJzZSIsImluZGV4IiwicGFyZW50IiwibmVnYXRlIiwiaXNFbXB0eSIsInJlbW92ZUNoaWxkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7Ozs7OztBQVFPLElBQU1BLHdEQUF3QixTQUF4QkEscUJBQXdCLENBQUNDLEdBQUQsRUFBaUM7QUFDcEUsTUFBTUMsV0FBNEIsRUFBbEM7QUFDQUQsTUFBSUUsY0FBSixDQUFtQixTQUFuQixFQUE4QjtBQUFBLFdBQVFELFNBQVNFLElBQVQsQ0FBY0MsSUFBZCxDQUFSO0FBQUEsR0FBOUI7O0FBRUEsU0FBT0MsYUFBR0MsT0FBSCxDQUNMRCxhQUFHRSxNQUFILENBQVUsVUFBQ0Ms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QUgsQ0FBVXhDLGFBQUd5QyxPQUFiLENBREYsRUFFRXpDLGFBQUdnQixJQUFILENBQVEsRUFBRVAsTUFBTSxPQUFSLEVBQWlCRSxTQUFTLFFBQTFCLEVBQVIsQ0FGRixFQUdFWCxhQUFHZSxHQUFILENBQU8sU0FBUCxDQUhGLEVBSUVmLGFBQUdnQixJQUFILENBQVEsRUFBRVAsTUFBTSxhQUFSLEVBQVIsQ0FKRixFQUtFVCxhQUFHZSxHQUFILENBQU8sU0FBUCxDQUxGLEVBTUVmLGFBQUdnQixJQUFILENBQVEsRUFBRVAsTUFBTSxVQUFSLEVBQVIsQ0FORixFQU9FVCxhQUFHZSxHQUFILENBQU8sU0FBUCxDQVBGLEVBUUVoQixJQVJGLENBREYsRUFVRTtBQUNBd0MsZUFBT0csV0FBUCxDQUFtQkosS0FBbkI7QUFDRDtBQUNGO0FBQ0YsR0FoQkQ7QUFpQkQsQ0FsQk0iLCJmaWxlIjoidHJhdmVyc2FsVXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cbmltcG9ydCBmcCBmcm9tICdsb2Rhc2gvZnAnO1xuXG5pbXBvcnQgdHlwZSB7IGdBU1ROb2RlIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG50eXBlIGNsYXNzTWFwVHlwZSA9IHtcbiAgW2tleTogc3RyaW5nXTogYm9vbGVhbixcbn1cblxuZXhwb3J0IGNvbnN0IGdldElDU1NFeHBvcnRQcm9wc01hcCA9IChhc3Q6IGdBU1ROb2RlKTogY2xhc3NNYXBUeXBlID0+IHtcbiAgY29uc3QgcnVsZVNldHM6IEFycmF5PGdBU1ROb2RlPiA9IFtdO1xuICBhc3QudHJhdmVyc2VCeVR5cGUoJ3J1bGVzZXQnLCBub2RlID0+IHJ1bGVTZXRzLnB1c2gobm9kZSkpO1xuXG4gIHJldHVybiBmcC5jb21wb3NlKFxuICAgIGZwLnJlZHVjZSgocmVzdWx0LCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IHByb3AgPSBmcC5jb21wb3NlKGZwLm50aCgwKSwgZnAubWFwKCdjb250ZW50JykpKGtleSk7XG4gICAgICByZXN1bHRbcHJvcF0gPSBwcm9wOyAvLyBlLmcuIHsgbXlQcm9wOiAnbXlQcm9wJyB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIHt9KSxcbiAgICBmcC5tYXAoJ2NvbnRlbnQnKSxcbiAgICBmcC5maWx0ZXIoeyB0eXBlOiAncHJvcGVydHknIH0pLFxuICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICBmcC5maWx0ZXIoeyB0eXBlOiAnZGVjbGFyYXRpb24nIH0pLFxuICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICBmcC5maWx0ZXIoeyB0eXBlOiAnYmxvY2snIH0pLFxuICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICBmcC5maWx0ZXIoe1xuICAgICAgY29udGVudDogW3tcbiAgICAgICAgdHlwZTogJ3NlbGVjdG9yJyxcbiAgICAgICAgY29udGVudDogW3tcbiAgICAgICAgICB0eXBlOiAncHNldWRvQ2xhc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IFt7XG4gICAgICAgICAgICB0eXBlOiAnaWRlbnQnLCBjb250ZW50OiAnZXhwb3J0J1xuICAgICAgICAgIH1dXG4gICAgICAgIH1dXG4gICAgICB9XVxuICAgIH0pXG4gICkocnVsZVNldHMpO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFJlZ3VsYXJDbGFzc2VzTWFwID0gKGFzdDogZ0FTVE5vZGUpOiBjbGFzc01hcFR5cGUgPT4ge1xuICBjb25zdCBydWxlU2V0czogQXJyYXk8Z0FTVE5vZGU+ID0gW107XG4gIGFzdC50cmF2ZXJzZUJ5VHlwZSgncnVsZXNldCcsIG5vZGUgPT4gcnVsZVNldHMucHVzaChub2RlKSk7XG5cbiAgcmV0dXJuIGZwLmNvbXBvc2UoXG4gICAgZnAucmVkdWNlKChyZXN1bHQsIGtleSkgPT4ge1xuICAgICAgcmVzdWx0W2tleV0gPSBmYWxzZTsgLy8gY2xhc3NlcyBoYXZlbid0IGJlZW4gdXNlZFxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7fSksXG4gICAgZnAubWFwKCdjb250ZW50JyksXG4gICAgZnAuZmlsdGVyKHsgdHlwZTogJ2lkZW50JyB9KSxcbiAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgZnAuZmlsdGVyKHsgdHlwZTogJ2NsYXNzJyB9KSxcbiAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgZnAuZmlsdGVyKHsgdHlwZTogJ3NlbGVjdG9yJyB9KSxcbiAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICkocnVsZVNldHMpO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldENvbXBvc2VzQ2xhc3Nlc01hcCA9IChhc3Q6IGdBU1ROb2RlKTogY2xhc3NNYXBUeXBlID0+IHtcbiAgY29uc3QgZGVjbGFyYXRpb25zID0gW107XG4gIGFzdC50cmF2ZXJzZUJ5VHlwZSgnZGVjbGFyYXRpb24nLCBub2RlID0+IGRlY2xhcmF0aW9ucy5wdXNoKG5vZGUpKTtcblxuICByZXR1cm4gZnAuY29tcG9zZShcbiAgICBmcC5yZWR1Y2UoKHJlc3VsdCwga2V5KSA9PiB7XG4gICAgICByZXN1bHRba2V5XSA9IHRydWU7IC8vIG1hcmsgY29tcG9zZWQgY2xhc3NlcyBhcyB0cnVlXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIHt9KSxcbiAgICBmcC5mbGF0TWFwKGZwLmNvbXBvc2UoXG4gICAgICBmcC5tYXAoZnAuZ2V0KCdjb250ZW50JykpLFxuICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ2lkZW50JyB9KSxcbiAgICAgIGZwLmdldCgnY29udGVudCcpLFxuICAgICAgZnAuZmluZCh7IHR5cGU6ICd2YWx1ZScgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICApKSxcbiAgICAvKlxuICAgICAgIHJlamVjdCBjbGFzc2VzIGNvbXBvc2luZyBmcm9tIG90aGVyIGZpbGVzXG4gICAgICAgZWcuXG4gICAgICAgLmZvbyB7XG4gICAgICAgY29tcG9zZXM6IC5iYXIgZnJvbSAnLi9vdGhlckZpbGUnO1xuICAgICAgIH1cbiAgICAgKi9cbiAgICBmcC5yZWplY3QoZnAuY29tcG9zZShcbiAgICAgIGZwLmZpbmQoeyB0eXBlOiAnaWRlbnQnLCBjb250ZW50OiAnZnJvbScgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbmQoeyB0eXBlOiAndmFsdWUnIH0pLFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgKSksXG4gICAgZnAuZmlsdGVyKGZwLmNvbXBvc2UoXG4gICAgICBmcC5maW5kKHsgdHlwZTogJ2lkZW50JywgY29udGVudDogJ2NvbXBvc2VzJyB9KSxcbiAgICAgIGZwLmdldCgnY29udGVudCcpLFxuICAgICAgZnAuZmluZCh7IHR5cGU6ICdwcm9wZXJ0eScgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICApKSxcbiAgKShkZWNsYXJhdGlvbnMpO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldEV4dGVuZENsYXNzZXNNYXAgPSAoYXN0OiBnQVNUTm9kZSk6IGNsYXNzTWFwVHlwZSA9PiB7XG4gIGNvbnN0IGV4dGVuZE5vZGVzID0gW107XG4gIGFzdC50cmF2ZXJzZUJ5VHlwZSgnZXh0ZW5kJywgbm9kZSA9PiBleHRlbmROb2Rlcy5wdXNoKG5vZGUpKTtcblxuICByZXR1cm4gZnAuY29tcG9zZShcbiAgICBmcC5yZWR1Y2UoKHJlc3VsdCwga2V5KSA9PiB7XG4gICAgICByZXN1bHRba2V5XSA9IHRydWU7IC8vIG1hcmsgZXh0ZW5kIGNsYXNzZXMgYXMgdHJ1ZVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7fSksXG4gICAgZnAubWFwKGZwLmNvbXBvc2UoXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbmQoeyB0eXBlOiAnaWRlbnQnIH0pLFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgICBmcC5maW5kKHsgdHlwZTogJ2NsYXNzJyB9KSxcbiAgICAgIGZwLmdldCgnY29udGVudCcpLFxuICAgICAgZnAuZmluZCh7IHR5cGU6ICdzZWxlY3RvcicgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICApKSxcbiAgKShleHRlbmROb2Rlcyk7XG59O1xuXG4vKipcbiAqIFJlc29sdmVzIHBhcmVudCBzZWxlY3RvcnMgdG8gdGhlaXIgZnVsbCBjbGFzcyBuYW1lcy5cbiAqXG4gKiBFLmcuIGAuZm9vIHsgJl9iYXIge2NvbG9yOiBibHVlIH0gfWAgdG8gYC5mb29fYmFyYC5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldFBhcmVudFNlbGVjdG9yQ2xhc3Nlc01hcCA9IChhc3Q6IGdBU1ROb2RlKTogY2xhc3NNYXBUeXBlID0+IHtcbiAgY29uc3QgY2xhc3Nlc01hcDogY2xhc3NNYXBUeXBlID0ge307XG5cbiAgLy8gUmVjdXJzaXZlbHkgdHJhdmVyc2VzIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgcGFyZW50IHNlbGVjdG9yXG4gIC8vIGV4dGVuc2lvbnMuIFJlY3Vyc2lvbiBpcyBuZWNlc3NhcnkgYXMgdGhlc2Ugc2VsZWN0b3JzIGNhbiBiZSBuZXN0ZWQuXG4gIGNvbnN0IGdldEV4dGVuc2lvbnMgPSBub2RlQ29udGVudCA9PiB7XG4gICAgY29uc3QgYmxvY2tDb250ZW50ID0gZnAuY29tcG9zZShcbiAgICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdibG9jaycgfSlcbiAgICApKG5vZGVDb250ZW50KTtcblxuICAgIGNvbnN0IHJ1bGVzZXRzQ29udGVudCA9IGZwLmZsYXRNYXAoJ2NvbnRlbnQnLCBmcC5jb25jYXQoXG4gICAgICAvLyBgcnVsZXNldGAgY2hpbGRyZW5cbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdydWxlc2V0JyB9LCBibG9ja0NvbnRlbnQpLFxuXG4gICAgICAvLyBgcnVsZXNldGAgZGVzY2VuZGFudHMgbmVzdGVkIGluIGBpbmNsdWRlYCBub2Rlc1xuICAgICAgZnAuY29tcG9zZShcbiAgICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ3J1bGVzZXQnIH0pLFxuICAgICAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdibG9jaycgfSksXG4gICAgICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ2luY2x1ZGUnIH0pXG4gICAgICApKGJsb2NrQ29udGVudClcbiAgICApKTtcblxuICAgIGNvbnN0IGV4dGVuc2lvbnMgPSBmcC5jb21wb3NlKFxuICAgICAgZnAubWFwKCdjb250ZW50JyksXG4gICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnaWRlbnQnIH0pLFxuICAgICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ3BhcmVudFNlbGVjdG9yRXh0ZW5zaW9uJyB9KSxcbiAgICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdzZWxlY3RvcicgfSlcbiAgICApKHJ1bGVzZXRzQ29udGVudCk7XG5cbiAgICBpZiAoIWV4dGVuc2lvbnMubGVuZ3RoKSByZXR1cm4gW107XG5cbiAgICBjb25zdCBuZXN0ZWRFeHRlbnNpb25zID0gZ2V0RXh0ZW5zaW9ucyhydWxlc2V0c0NvbnRlbnQpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGV4dGVuc2lvbnM7XG4gICAgaWYgKG5lc3RlZEV4dGVuc2lvbnMubGVuZ3RoKSB7XG4gICAgICBuZXN0ZWRFeHRlbnNpb25zLmZvckVhY2gobmVzdGVkRXh0ID0+IHtcbiAgICAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKGV4dCA9PiB7XG4gICAgICAgICAgcmVzdWx0LnB1c2goZXh0ICsgbmVzdGVkRXh0KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIGFzdC50cmF2ZXJzZUJ5VHlwZSgncnVsZXNldCcsIG5vZGUgPT4ge1xuICAgIGNvbnN0IGNsYXNzTmFtZXMgPSBmcC5jb21wb3NlKFxuICAgICAgZnAubWFwKCdjb250ZW50JyksXG4gICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnaWRlbnQnIH0pLFxuICAgICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ2NsYXNzJyB9KSxcbiAgICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdzZWxlY3RvcicgfSlcbiAgICApKG5vZGUuY29udGVudCk7XG5cbiAgICBpZiAoIWNsYXNzTmFtZXMubGVuZ3RoKSByZXR1cm47XG5cbiAgICBjb25zdCBleHRlbnNpb25zID0gZ2V0RXh0ZW5zaW9ucyhub2RlLmNvbnRlbnQpO1xuICAgIGlmICghZXh0ZW5zaW9ucy5sZW5ndGgpIHJldHVybjtcblxuICAgIGNsYXNzTmFtZXMuZm9yRWFjaChjbGFzc05hbWUgPT4ge1xuICAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKGV4dCA9PiB7XG4gICAgICAgIGNsYXNzZXNNYXBbY2xhc3NOYW1lICsgZXh0XSA9IGZhbHNlO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIElnbm9yZSB0aGUgYmFzZSBjbGFzcyBpZiBpdCBvbmx5IGV4aXN0cyBmb3IgbmVzdGluZyBwYXJlbnQgc2VsZWN0b3JzXG4gICAgICBjb25zdCBoYXNEZWNsYXJhdGlvbnMgPSBmcC5jb21wb3NlKFxuICAgICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnZGVjbGFyYXRpb24nIH0pLFxuICAgICAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdibG9jaycgfSlcbiAgICAgICkobm9kZS5jb250ZW50KS5sZW5ndGggPiAwO1xuICAgICAgaWYgKCFoYXNEZWNsYXJhdGlvbnMpIGNsYXNzZXNNYXBbY2xhc3NOYW1lXSA9IHRydWU7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJldHVybiBjbGFzc2VzTWFwO1xufTtcblxuLypcbiAgIG11dGF0ZXMgYXN0IGJ5IHJlbW92aW5nIGluc3RhbmNlcyBvZiA6Z2xvYmFsXG4gKi9cbmV4cG9ydCBjb25zdCBlbGltaW5hdGVHbG9iYWxzID0gKGFzdDogZ0FTVE5vZGUpID0+IHtcbiAgYXN0LnRyYXZlcnNlKChub2RlLCBpbmRleCwgcGFyZW50KSA9PiB7XG4gICAgaWYgKG5vZGUudHlwZSA9PT0gJ3J1bGVzZXQnKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGZwLmNvbXBvc2UoXG4gICAgICAgICAgZnAubmVnYXRlKGZwLmlzRW1wdHkpLFxuICAgICAgICAgIGZwLmZpbmQoeyB0eXBlOiAnaWRlbnQnLCBjb250ZW50OiAnZ2xvYmFsJyB9KSxcbiAgICAgICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgICAgICBmcC5maW5kKHsgdHlwZTogJ3BzZXVkb0NsYXNzJyB9KSxcbiAgICAgICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgICAgICBmcC5maW5kKHsgdHlwZTogJ3NlbGVjdG9yJyB9KSxcbiAgICAgICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgICAgKShub2RlKVxuICAgICAgKSB7XG4gICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChpbmRleCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn07XG4iXX0=